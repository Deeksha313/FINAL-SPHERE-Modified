{% extends "base.html" %}

{% block title %}Security Assessment Results - SecureSphere{% endblock %}

{% block content %}
<div class="dashboard-header text-center mb-4">
    <h1 class="display-6 fw-bold mb-2">
        <i class="bi bi-shield-check me-3"></i>Security Assessment Results
    </h1>
    <p class="lead mb-0">Comprehensive analysis of your security posture by dimension</p>
</div>

<!-- Key Metrics Dashboard -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card maturity-score-card">
            <div class="metric-icon">
                <i class="bi bi-award-fill"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ maturity_score }}/5</h3>
                <p class="metric-label">MATURITY SCORE</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="bi bi-check2-circle"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ responses|length }}</h3>
                <p class="metric-label">Total Responses</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="bi bi-layers"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ dimension_scores|length }}</h3>
                <p class="metric-label">Security Dimensions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="bi bi-graph-up"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">{{ "%.1f"|format((dimension_scores.values()|map(attribute='average_score')|sum / dimension_scores|length) if dimension_scores else 0) }}</h3>
                <p class="metric-label">Average Score</p>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Security Maturity Heatmap -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-gradient-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-grid-3x3-gap me-2"></i>Security Maturity Heatmap
                        </h5>
                        <small class="opacity-75">Color-coded visualization of your security maturity across all dimensions</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" onclick="exportHeatmapData()" title="Export heatmap data">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="toggleHeatmapView()" title="Toggle view">
                            <i class="bi bi-eye me-1"></i>Toggle View
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <!-- Overall Maturity Level Display -->
                <div class="maturity-level-display mb-4">
                    <div class="text-center">
                        <h4 class="mb-2">Overall Maturity Level</h4>
                        <div class="maturity-badge-large level-{{ maturity_score }}">
                            <div class="level-number">{{ maturity_score }}</div>
                            <div class="level-text">
                                {% if maturity_score == 1 %}
                                    Initial
                                {% elif maturity_score == 2 %}
                                    Developing
                                {% elif maturity_score == 3 %}
                                    Defined
                                {% elif maturity_score == 4 %}
                                    Managed
                                {% elif maturity_score == 5 %}
                                    Optimized
                                {% else %}
                                    Not Assessed
                                {% endif %}
                            </div>
                        </div>
                        <p class="text-muted mt-2">
                            {% if maturity_score == 1 %}
                                Basic security measures in place with ad-hoc processes
                            {% elif maturity_score == 2 %}
                                Some security processes defined but inconsistently applied
                            {% elif maturity_score == 3 %}
                                Well-defined security processes documented and followed
                            {% elif maturity_score == 4 %}
                                Security processes are measured and controlled
                            {% elif maturity_score == 5 %}
                                Continuous improvement with optimized security processes
                            {% else %}
                                Complete your assessment to see your maturity level
                            {% endif %}
                        </p>
                    </div>
                </div>

                <!-- Risk Matrix Style Heatmap -->
                {% if dimension_scores %}
                <div class="heatmap-risk-matrix mb-4">
                    <h6 class="text-muted mb-3">
                        <i class="bi bi-grid me-2"></i>Risk-based Maturity Matrix
                    </h6>
                    <div class="matrix-container">
                        <div class="matrix-labels">
                            <div class="y-axis-label">
                                <span class="label-text">IMPACT</span>
                            </div>
                            <div class="y-axis-values">
                                <div class="axis-value">Catastrophic (5)</div>
                                <div class="axis-value">Significant (4)</div>
                                <div class="axis-value">Moderate (3)</div>
                                <div class="axis-value">Low (2)</div>
                                <div class="axis-value">Negligible (1)</div>
                            </div>
                        </div>
                        <div class="matrix-content">
                            <div class="matrix-grid">
                                {% for row in range(5, 0, -1) %}
                                <div class="matrix-row">
                                    {% for col in range(1, 6) %}
                                    {% set cell_value = row * col %}
                                    {% set cell_class = 'high' if cell_value >= 20 else 'medium-high' if cell_value >= 15 else 'medium' if cell_value >= 10 else 'low-medium' if cell_value >= 5 else 'low' %}
                                    <div class="matrix-cell {{ cell_class }}" data-impact="{{ row }}" data-likelihood="{{ col }}" data-value="{{ cell_value }}">
                                        <span class="cell-value">{{ cell_value }}</span>
                                        {% set matching_dimensions = [] %}
                                        {% for dimension, score_data in dimension_scores.items() %}
                                            {% set score_level = score_data.average_score|round|int %}
                                            {% if score_level == col and ((score_level >= 4 and row >= 4) or (score_level == 3 and row == 3) or (score_level <= 2 and row <= 2)) %}
                                                {% set _ = matching_dimensions.append(dimension) %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if matching_dimensions %}
                                        <div class="cell-dimensions">
                                            {% for dim in matching_dimensions[:2] %}
                                            <small class="dimension-tag">{{ dim[:3] }}</small>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="x-axis">
                                <div class="x-axis-label">LIKELIHOOD</div>
                                <div class="x-axis-values">
                                    <div class="axis-value">Improbable (1)</div>
                                    <div class="axis-value">Remote (2)</div>
                                    <div class="axis-value">Occasional (3)</div>
                                    <div class="axis-value">Probable (4)</div>
                                    <div class="axis-value">Frequent (5)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Matrix Legend -->
                    <div class="matrix-legend mt-3">
                        <div class="d-flex justify-content-center flex-wrap gap-3">
                            <div class="legend-item">
                                <span class="legend-color high"></span>
                                <span class="legend-text">High Risk (20-25)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color medium-high"></span>
                                <span class="legend-text">Medium-High (15-19)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color medium"></span>
                                <span class="legend-text">Medium (10-14)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color low-medium"></span>
                                <span class="legend-text">Low-Medium (5-9)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color low"></span>
                                <span class="legend-text">Low (1-4)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section-wise Performance -->
                <div class="section-performance mb-4">
                    <h6 class="text-muted mb-3">
                        <i class="bi bi-bar-chart me-2"></i>Section-wise Performance Breakdown
                    </h6>
                    <div class="row">
                        {% for section, data in section_dimensions.items() %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="section-card level-{{ (data.percentage / 20)|round|int }}">
                                <div class="section-header">
                                    <h6 class="section-title">{{ section }}</h6>
                                    <span class="section-percentage">{{ data.percentage }}%</span>
                                </div>
                                <div class="section-progress mb-2">
                                    <div class="progress">
                                        <div class="progress-bar level-{{ (data.percentage / 20)|round|int }}-bg" 
                                             style="width: {{ data.percentage }}%"></div>
                                    </div>
                                </div>
                                <div class="section-details">
                                    <small class="text-muted">
                                        {{ data.question_count }} questions • 
                                        {{ data.total_score }}/{{ data.max_possible_score }} points •
                                        Level {{ (data.percentage / 20)|round|int }}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Traditional Heatmap Grid -->
                <div class="heatmap-container" id="traditionalHeatmap">
                    <h6 class="text-muted mb-3">
                        <i class="bi bi-grid-3x3-gap me-2"></i>Dimension Maturity Grid
                    </h6>
                    <div class="row">
                        {% for dimension, score_data in dimension_scores.items() %}
                        <div class="col-md-6 col-lg-4 col-xl-3 mb-3">
                            <div class="heatmap-cell level-{{ score_data.average_score|round|int }}" 
                                 data-bs-toggle="tooltip" 
                                 data-bs-placement="top" 
                                 title="{{ dimension }}: {{ score_data.average_score }}/5 ({{ score_data.question_count }} questions)">
                                <div class="cell-header">
                                    <h6 class="dimension-title">{{ dimension }}</h6>
                                    <span class="maturity-level">Level {{ score_data.average_score|round|int }}</span>
                                </div>
                                <div class="cell-body">
                                    <div class="score-display">{{ score_data.average_score }}/5</div>
                                    <div class="questions-count">{{ score_data.question_count }} questions</div>
                                </div>
                                <div class="cell-progress">
                                    <div class="progress">
                                        <div class="progress-bar level-{{ score_data.average_score|round|int }}-bg" 
                                             style="width: {{ (score_data.average_score / 5 * 100)|round }}%"></div>
                                    </div>
                                </div>
                                <div class="cell-footer">
                                    <small class="improvement-indicator">
                                        {% set level = score_data.average_score|round|int %}
                                        {% if level >= 4 %}
                                            <i class="bi bi-check-circle text-success"></i> Excellent
                                        {% elif level == 3 %}
                                            <i class="bi bi-shield-check text-info"></i> Good
                                        {% elif level == 2 %}
                                            <i class="bi bi-exclamation-triangle text-warning"></i> Needs Work
                                        {% else %}
                                            <i class="bi bi-x-circle text-danger"></i> Critical
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Maturity Legend -->
                <div class="maturity-legend mt-4">
                    <h6 class="mb-3">Maturity Levels</h6>
                    <div class="row">
                        <div class="col-md-2 col-sm-4 col-6 mb-2">
                            <div class="legend-item level-1">
                                <span class="legend-color"></span>
                                <span class="legend-text">Level 1 - Initial</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-2">
                            <div class="legend-item level-2">
                                <span class="legend-color"></span>
                                <span class="legend-text">Level 2 - Developing</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-2">
                            <div class="legend-item level-3">
                                <span class="legend-color"></span>
                                <span class="legend-text">Level 3 - Defined</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-2">
                            <div class="legend-item level-4">
                                <span class="legend-color"></span>
                                <span class="legend-text">Level 4 - Managed</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-2">
                            <div class="legend-item level-5">
                                <span class="legend-color"></span>
                                <span class="legend-text">Level 5 - Optimized</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Dimension Scores Overview -->
{% if dimension_scores %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>Dimension-wise Scores
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for dimension, score_data in dimension_scores.items() %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="dimension-score-card">
                            <div class="dimension-name">{{ dimension }}</div>
                            <div class="dimension-score">{{ score_data.average_score }}/5</div>
                            <div class="dimension-details">
                                <small class="text-muted">
                                    {{ score_data.question_count }} questions • 
                                    Total: {{ score_data.total_score }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Security Dimensions Results -->
<div class="results-container">
    {% if responses %}
        {% set sections = {} %}
        {% for resp in responses %}
            {% if resp.section not in sections %}
                {% set _ = sections.update({resp.section: []}) %}
            {% endif %}
            {% set _ = sections[resp.section].append(resp) %}
        {% endfor %}

        <!-- Section Navigation -->
        <div class="section-navigation mb-4">
            <nav class="nav nav-pills nav-fill">
                {% for section_name in sections.keys() %}
                    <button class="nav-link {% if loop.first %}active{% endif %}"
                            data-bs-toggle="pill"
                            data-bs-target="#section-{{ loop.index0 }}"
                            type="button">
                        <i class="bi bi-shield-shaded me-2"></i>
                        {{ section_name }}
                        <span class="badge bg-light text-dark ms-2">{{ sections[section_name]|length }}</span>
                    </button>
                {% endfor %}
            </nav>
        </div>

        <!-- Section Content -->
        <div class="tab-content" id="sectionsContent">
            {% for section_name, section_responses in sections.items() %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
                     id="section-{{ loop.index0 }}">

                    <!-- Section Header -->
                    <div class="section-header-card mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="mb-1">
                                    <i class="bi bi-shield-fill text-primary me-2"></i>
                                    {{ section_name }}
                                </h4>
                                <p class="text-muted mb-0">{{ section_responses|length }} questions assessed</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="section-score">
                                    <span class="score-value" data-section="{{ section_name }}">-</span>
                                    <span class="score-label">Section Score</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Questions Grid -->
                    <div class="questions-grid">
                        {% for resp in section_responses %}
                            {% set lead_comment = resp.lead_comments|first %}
                            <div class="question-card {% if lead_comment %}status-{{ lead_comment.status }}{% else %}status-pending{% endif %}">
                                <div class="question-header">
                                    <div class="question-number">
                                        <span class="number">{{ loop.index }}</span>
                                    </div>
                                    <div class="question-status">
                                        {% if lead_comment %}
                                            {% if lead_comment.status == 'approved' %}
                                                <span class="status-indicator approved">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                </span>
                                            {% elif lead_comment.status == 'needs_revision' %}
                                                <span class="status-indicator revision">
                                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                                </span>
                                            {% elif lead_comment.status == 'rejected' %}
                                                <span class="status-indicator rejected">
                                                    <i class="bi bi-x-circle-fill"></i>
                                                </span>
                                            {% else %}
                                                <span class="status-indicator pending">
                                                    <i class="bi bi-clock-fill"></i>
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="status-indicator pending">
                                                <i class="bi bi-clock-fill"></i>
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="question-content">
                                    <h6 class="question-text">{{ resp.question }}</h6>

                                    <div class="answer-section">
                                        <div class="answer-label">Your Answer:</div>
                                        <div class="answer-value">{{ resp.answer }}</div>
                                    </div>

                                    {% if resp.client_comment %}
                                        <div class="comment-section">
                                            <div class="comment-label">
                                                <i class="bi bi-chat-text me-1"></i>Your Comment:
                                            </div>
                                            <div class="comment-value">{{ resp.client_comment }}</div>
                                        </div>
                                    {% endif %}

                                    {% if resp.evidence_path %}
                                        <div class="evidence-section">
                                            <div class="evidence-label">
                                                <i class="bi bi-paperclip me-1"></i>Evidence:
                                            </div>
                                            <a href="/{{ resp.evidence_path }}" target="_blank"
                                               class="evidence-link">
                                                <i class="bi bi-file-earmark"></i>
                                                View Attachment
                                            </a>
                                        </div>
                                    {% endif %}

                                    {% if lead_comment and lead_comment.comment %}
                                        <div class="reviewer-feedback">
                                            <div class="feedback-label">
                                                <i class="bi bi-person-badge me-1"></i>Reviewer Feedback:
                                            </div>
                                            <div class="feedback-content">{{ lead_comment.comment }}</div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-results">
            <div class="text-center py-5">
                <i class="bi bi-clipboard-data display-1 text-muted mb-3"></i>
                <h5 class="text-muted">No Assessment Data</h5>
                <p class="text-muted">Complete your security questionnaire to view results here.</p>
                <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    {% endif %}
</div>

<style>
/* Enhanced Heatmap Styles */
.matrix-container {
    display: flex;
    align-items: stretch;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.matrix-labels {
    display: flex;
    align-items: stretch;
    margin-right: 15px;
}

.y-axis-label {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    font-weight: bold;
    color: #374151;
    margin-right: 10px;
}

.y-axis-values {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    width: 120px;
}

.matrix-content {
    flex: 1;
}

.matrix-grid {
    display: flex;
    flex-direction: column;
    border: 2px solid #e5e7eb;
    border-radius: 4px;
}

.matrix-row {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
}

.matrix-row:last-child {
    border-bottom: none;
}

.matrix-cell {
    flex: 1;
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-right: 1px solid #e5e7eb;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 80px;
}

.matrix-cell:last-child {
    border-right: none;
}

.matrix-cell:hover {
    transform: scale(1.05);
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.matrix-cell.low { background-color: #10b981; }
.matrix-cell.low-medium { background-color: #f59e0b; }
.matrix-cell.medium { background-color: #f59e0b; }
.matrix-cell.medium-high { background-color: #ef4444; }
.matrix-cell.high { background-color: #dc2626; }

.cell-value {
    font-weight: bold;
    color: white;
    font-size: 1.1rem;
}

.cell-dimensions {
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 2px;
}

.dimension-tag {
    background: rgba(255,255,255,0.8);
    color: #374151;
    padding: 1px 4px;
    border-radius: 2px;
    font-size: 0.7rem;
    font-weight: 500;
}

.x-axis {
    margin-top: 15px;
}

.x-axis-label {
    text-align: center;
    font-weight: bold;
    color: #374151;
    margin-bottom: 8px;
}

.x-axis-values, .y-axis-values {
    display: flex;
    justify-content: space-between;
    gap: 1px;
}

.x-axis-values {
    margin-top: 8px;
}

.axis-value {
    flex: 1;
    text-align: center;
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 500;
    padding: 4px 2px;
}

.y-axis-values .axis-value {
    text-align: right;
    padding-right: 8px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
}

.matrix-legend {
    text-align: center;
}

.matrix-legend .legend-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin: 0 15px;
}

.matrix-legend .legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
}

.matrix-legend .legend-color.low { background-color: #10b981; }
.matrix-legend .legend-color.low-medium { background-color: #f59e0b; }
.matrix-legend .legend-color.medium { background-color: #f59e0b; }
.matrix-legend .legend-color.medium-high { background-color: #ef4444; }
.matrix-legend .legend-color.high { background-color: #dc2626; }

/* Enhanced Section Cards */
.section-card {
    background: white;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #e5e7eb;
    transition: all 0.3s ease;
}

.section-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.section-card.level-1 { border-left-color: #ef4444; }
.section-card.level-2 { border-left-color: #f59e0b; }
.section-card.level-3 { border-left-color: #eab308; }
.section-card.level-4 { border-left-color: #22c55e; }
.section-card.level-5 { border-left-color: #10b981; }

/* Enhanced Heatmap Cells */
.heatmap-cell {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 2px solid transparent;
    transition: all 0.3s ease;
    cursor: pointer;
}

.heatmap-cell:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.heatmap-cell.level-1 { 
    border-color: #ef4444; 
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
}
.heatmap-cell.level-2 { 
    border-color: #f59e0b; 
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
}
.heatmap-cell.level-3 { 
    border-color: #eab308; 
    background: linear-gradient(135deg, #fefce8 0%, #fef08a 100%);
}
.heatmap-cell.level-4 { 
    border-color: #22c55e; 
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
}
.heatmap-cell.level-5 { 
    border-color: #10b981; 
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
}

.dimension-title {
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.maturity-level {
    font-size: 0.75rem;
    font-weight: 500;
    color: #6b7280;
}

.score-display {
    font-size: 1.5rem;
    font-weight: bold;
    color: #1f2937;
    margin: 8px 0;
}

.questions-count {
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 12px;
}

.cell-progress .progress {
    height: 6px;
    border-radius: 3px;
    background: #f3f4f6;
}

.level-1-bg { background-color: #ef4444 !important; }
.level-2-bg { background-color: #f59e0b !important; }
.level-3-bg { background-color: #eab308 !important; }
.level-4-bg { background-color: #22c55e !important; }
.level-5-bg { background-color: #10b981 !important; }

.cell-footer {
    margin-top: 8px;
    text-align: center;
}

.improvement-indicator {
    font-weight: 500;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .matrix-container {
        flex-direction: column;
        padding: 15px;
    }
    
    .matrix-labels {
        flex-direction: row;
        margin-right: 0;
        margin-bottom: 15px;
    }
    
    .y-axis-label {
        writing-mode: horizontal-tb;
        width: auto;
        height: 30px;
        margin-right: 15px;
        margin-bottom: 0;
    }
    
    .y-axis-values {
        flex-direction: row;
        width: auto;
    }
    
    .y-axis-values .axis-value {
        height: auto;
        padding: 4px 8px;
        text-align: center;
    }
    
    .matrix-cell {
        min-height: 60px;
    }
    
    .axis-value {
        font-size: 0.65rem;
    }
    
    .heatmap-cell {
        padding: 15px;
    }
    
    .score-display {
        font-size: 1.25rem;
    }
}
</style>

<script>
// Calculate and display scores
document.addEventListener('DOMContentLoaded', function() {
    const responses = {{ responses_json | tojson }};
    const sections = {};

    // Group responses by section
    responses.forEach(resp => {
        if (!sections[resp.section]) {
            sections[resp.section] = [];
        }
        sections[resp.section].push(resp);
    });

    // Calculate section scores
    let totalScore = 0;
    let totalQuestions = 0;
    const sectionCount = Object.keys(sections).length;

    Object.keys(sections).forEach(sectionName => {
        const sectionResponses = sections[sectionName];
        const sectionScore = calculateSectionScore(sectionResponses);

        // Update section score display
        const scoreElement = document.querySelector(`[data-section="${sectionName}"]`);
        if (scoreElement) {
            scoreElement.textContent = sectionScore + '%';
        }

        totalScore += sectionScore;
        totalQuestions += sectionResponses.length;
    });

    // Update overall metrics
    const overallScore = sectionCount > 0 ? Math.round(totalScore / sectionCount) : 0;
    const overallScoreElement = document.getElementById('overallScore');
    if (overallScoreElement) {
        overallScoreElement.textContent = overallScore + '%';
    }
});

function calculateSectionScore(responses) {
    if (responses.length === 0) return 0;

    let approvedCount = 0;
    responses.forEach(resp => {
        // Check if response has approved status
        if (resp.lead_comments && resp.lead_comments.length > 0) {
            if (resp.lead_comments[0].status === 'approved') {
                approvedCount++;
            }
        }
    });

    return Math.round((approvedCount / responses.length) * 100);
}

// Heatmap interaction functions
function toggleHeatmapView() {
    const traditionalHeatmap = document.getElementById('traditionalHeatmap');
    const isVisible = traditionalHeatmap.style.display !== 'none';
    traditionalHeatmap.style.display = isVisible ? 'none' : 'block';
    
    const toggleBtn = event.target.closest('button');
    const icon = toggleBtn.querySelector('i');
    const text = toggleBtn.querySelector('.btn-text');
    
    if (isVisible) {
        icon.className = 'bi bi-eye-slash me-1';
        if (text) text.textContent = 'Show Grid';
    } else {
        icon.className = 'bi bi-eye me-1';
        if (text) text.textContent = 'Hide Grid';
    }
}

// Initialize tooltips for heatmap cells
document.addEventListener('DOMContentLoaded', function() {
    // Add tooltips to heatmap cells
    const heatmapCells = document.querySelectorAll('.heatmap-cell');
    heatmapCells.forEach(cell => {
        const dimensionTitle = cell.querySelector('.dimension-title').textContent;
        const scoreDisplay = cell.querySelector('.score-display').textContent;
        const questionsCount = cell.querySelector('.questions-count').textContent;
        const level = cell.classList.toString().match(/level-(\d)/)?.[1] || '0';
        
        const levelNames = {
            '1': 'Initial - Basic security measures with ad-hoc processes',
            '2': 'Developing - Some processes defined but inconsistently applied',
            '3': 'Defined - Well-defined processes documented and followed',
            '4': 'Managed - Processes are measured and controlled',
            '5': 'Optimized - Continuous improvement with optimized processes'
        };
        
        const tooltipText = `${dimensionTitle}\nScore: ${scoreDisplay}\n${questionsCount}\nLevel: ${levelNames[level] || 'Not assessed'}`;
        
        cell.setAttribute('title', tooltipText);
        cell.setAttribute('data-bs-toggle', 'tooltip');
        cell.setAttribute('data-bs-placement', 'top');
    });
    
    // Add matrix cell interactions
    const matrixCells = document.querySelectorAll('.matrix-cell');
    matrixCells.forEach(cell => {
        cell.addEventListener('click', function() {
            const impact = this.dataset.impact;
            const likelihood = this.dataset.likelihood;
            const value = this.dataset.value;
            
            showMatrixCellDetails(impact, likelihood, value, this);
        });
    });
    
    // Initialize Bootstrap tooltips
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    // Add click animation to maturity badge
    const maturityBadge = document.querySelector('.maturity-badge-large');
    if (maturityBadge) {
        maturityBadge.addEventListener('click', function() {
            this.style.transform = 'scale(1.1)';
            setTimeout(() => {
                this.style.transform = '';
            }, 200);
        });
    }
});

function showMatrixCellDetails(impact, likelihood, value, cellElement) {
    const dimensions = cellElement.querySelectorAll('.dimension-tag');
    const dimensionNames = Array.from(dimensions).map(d => d.textContent);
    
    let riskLevel = 'Low';
    if (value >= 20) riskLevel = 'High';
    else if (value >= 15) riskLevel = 'Medium-High';
    else if (value >= 10) riskLevel = 'Medium';
    else if (value >= 5) riskLevel = 'Low-Medium';
    
    const details = `
        Risk Level: ${riskLevel}
        Risk Score: ${value}
        Impact Level: ${impact}
        Likelihood Level: ${likelihood}
        ${dimensionNames.length > 0 ? 'Related Dimensions: ' + dimensionNames.join(', ') : ''}
    `;
    
    // Create a simple alert for now - could be enhanced with a modal
    alert(details);
}

// Function to export heatmap data (if needed for reports)
function exportHeatmapData() {
    {% if maturity_score and dimension_scores %}
    const heatmapData = {
        product: '{{ product.name|escape }}',
        overallMaturityScore: {{ maturity_score }},
        assessmentDate: new Date().toISOString(),
        dimensions: [
            {% for dimension, score_data in dimension_scores.items() %}
            {
                name: '{{ dimension|escape }}',
                score: {{ score_data.average_score }},
                level: {{ score_data.average_score|round|int }},
                questionCount: {{ score_data.question_count }},
                totalScore: {{ score_data.total_score }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        {% if section_dimensions %}
        sections: [
            {% for section, data in section_dimensions.items() %}
            {
                name: '{{ section|escape }}',
                percentage: {{ data.percentage }},
                questionCount: {{ data.question_count }},
                totalScore: {{ data.total_score }},
                maxPossibleScore: {{ data.max_possible_score }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
        {% endif %}
    };
    
    // Download as JSON
    const dataStr = JSON.stringify(heatmapData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${heatmapData.product}_maturity_heatmap_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    // Show success message
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            Heatmap data exported successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
    {% endif %}
}
</script>
{% endblock %}